{% extends 'bookshelf/base.html' %}

{% block title %}{{ book.title }} - Bookshelf{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 1.5rem; margin-bottom: 2rem;">
    <div style="max-width: 250px; margin: 0 auto;">
        {% if book.cover_url %}
            <img src="{{ book.cover_url }}" alt="{{ book.title }}" style="width: 100%; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        {% else %}
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='250' height='350'%3E%3Crect fill='%23ddd' width='250' height='350'/%3E%3Ctext fill='%23999' x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-family='Arial'%3ENo Cover%3C/text%3E%3C/svg%3E" alt="No cover" style="width: 100%; border-radius: 8px;">
        {% endif %}
    </div>
    
    <div>
        <h1 style="font-size: 1.5rem;">{{ book.title }}</h1>
        <h2 style="color: #7f8c8d; font-size: 1.1rem; font-weight: normal; margin-bottom: 1rem;">by {{ book.author }}</h2>
        
        {% if book.published_year %}
            <p style="color: #95a5a6; margin-bottom: 0.5rem; font-size: 0.9rem;">Published: {{ book.published_year }}</p>
        {% endif %}
        
        {% if book.isbn %}
            <p style="color: #95a5a6; margin-bottom: 1rem; font-size: 0.9rem;">ISBN: {{ book.isbn }}</p>
        {% endif %}
        
        {% if book.description %}
            <p style="margin-bottom: 1.5rem; line-height: 1.8; font-size: 0.95rem;">{{ book.description }}</p>
        {% endif %}
        
        {% if user.is_authenticated %}
            <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                <a href="{% url 'edit_book' book.pk %}" class="btn btn-small" style="margin-right: 0.5rem; margin-bottom: 0.5rem; display: inline-block;">Edit Book</a>
                <a href="{% url 'delete_book' book.pk %}" class="btn btn-danger btn-small" style="margin-bottom: 0.5rem; display: inline-block;">Delete Book</a>
            </div>
        {% endif %}
        
        {% if user.is_authenticated %}
            <div style="margin-bottom: 2rem;">
                {% if user_shelf %}
                    <p style="margin-bottom: 0.5rem; font-size: 0.9rem;">On your shelf: <strong>{{ user_shelf.get_shelf_type_display }}</strong></p>
                    <form method="post" action="{% url 'add_to_shelf' book.pk %}" style="margin-bottom: 1rem;">
                        {% csrf_token %}
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                            <select name="shelf_type" style="padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; flex: 1; min-width: 150px;">
                                <option value="want_to_read" {% if user_shelf.shelf_type == 'want_to_read' %}selected{% endif %}>Want to Read</option>
                                <option value="currently_reading" {% if user_shelf.shelf_type == 'currently_reading' %}selected{% endif %}>Currently Reading</option>
                                <option value="read" {% if user_shelf.shelf_type == 'read' %}selected{% endif %}>Read</option>
                            </select>
                            <button type="submit" class="btn btn-small">Update</button>
                        </div>
                    </form>
                    {% if user_shelf.shelf_type == 'read' %}
                        <form method="post" action="{% url 'update_date_finished' book.pk %}" style="margin-bottom: 1rem;">
                            {% csrf_token %}
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.9rem;">Date finished:</label>
                                <input type="date" name="date_finished" value="{% if user_shelf.date_finished %}{{ user_shelf.date_finished|date:'Y-m-d' }}{% endif %}" style="padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; flex: 1; min-width: 150px;">
                                <button type="submit" class="btn btn-small">Save Date</button>
                            </div>
                        </form>
                    {% endif %}
                    <form method="post" action="{% url 'remove_from_shelf' book.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-secondary btn-small">Remove from Shelf</button>
                    </form>
                {% else %}
                    <form method="post" action="{% url 'add_to_shelf' book.pk %}">
                        {% csrf_token %}
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                            <select name="shelf_type" style="padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; flex: 1; min-width: 150px;">
                                <option value="want_to_read">Want to Read</option>
                                <option value="currently_reading">Currently Reading</option>
                                <option value="read">Read</option>
                            </select>
                            <button type="submit" class="btn btn-small">Add to Shelf</button>
                        </div>
                    </form>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

@media (min-width: 768px) {
    .book-detail-container {
        display: grid !important;
        grid-template-columns: 250px 1fr !important;
        gap: 2rem !important;
        flex-direction: row !important;
    }
    
    .book-detail-container > div:first-child {
        margin: 0 !important;
    }
}

<style>
.book-detail-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

@media (min-width: 768px) {
    .book-detail-container {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 2rem;
    }
    
    .book-detail-container > div:first-child {
        margin: 0;
    }
}
</style>

<div class="book-detail-container">
    <div style="max-width: 250px; margin: 0 auto;">
        {% if book.cover_url %}
            <img src="{{ book.cover_url }}" alt="{{ book.title }}" style="width: 100%; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        {% else %}
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='250' height='350'%3E%3Crect fill='%23ddd' width='250' height='350'/%3E%3Ctext fill='%23999' x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-family='Arial'%3ENo Cover%3C/text%3E%3C/svg%3E" alt="No cover" style="width: 100%; border-radius: 8px;">
        {% endif %}
    </div>
    
    <div>
        <h1>{{ book.title }}</h1>
        <h2 style="color: #7f8c8d; font-size: 1.2rem; font-weight: normal; margin-bottom: 1rem;">by {{ book.author }}</h2>
        
        {% if book.published_year %}
            <p style="color: #95a5a6; margin-bottom: 0.5rem;">Published: {{ book.published_year }}</p>
        {% endif %}
        
        {% if book.isbn %}
            <p style="color: #95a5a6; margin-bottom: 1rem;">ISBN: {{ book.isbn }}</p>
        {% endif %}
        
        {% if book.description %}
            <p style="margin-bottom: 1.5rem; line-height: 1.8;">{{ book.description }}</p>
        {% endif %}
        
        {% if user.is_authenticated %}
            <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                <a href="{% url 'edit_book' book.pk %}" class="btn btn-small" style="margin-right: 0.5rem; margin-bottom: 0.5rem; display: inline-block;">Edit Book</a>
                <a href="{% url 'delete_book' book.pk %}" class="btn btn-danger btn-small" style="margin-bottom: 0.5rem; display: inline-block;">Delete Book</a>
            </div>
        {% endif %}
        
        {% if user.is_authenticated %}
            <div style="margin-bottom: 2rem;">
                {% if user_shelf %}
                    <p style="margin-bottom: 0.5rem; font-size: 0.9rem;">On your shelf: <strong>{{ user_shelf.get_shelf_type_display }}</strong></p>
                    <form method="post" action="{% url 'add_to_shelf' book.pk %}" style="margin-bottom: 1rem;">
                        {% csrf_token %}
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                            <select name="shelf_type" style="padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; flex: 1; min-width: 150px;">
                                <option value="want_to_read" {% if user_shelf.shelf_type == 'want_to_read' %}selected{% endif %}>Want to Read</option>
                                <option value="currently_reading" {% if user_shelf.shelf_type == 'currently_reading' %}selected{% endif %}>Currently Reading</option>
                                <option value="read" {% if user_shelf.shelf_type == 'read' %}selected{% endif %}>Read</option>
                            </select>
                            <button type="submit" class="btn btn-small">Update</button>
                        </div>
                    </form>
                    {% if user_shelf.shelf_type == 'read' %}
                        <form method="post" action="{% url 'update_date_finished' book.pk %}" style="margin-bottom: 1rem;">
                            {% csrf_token %}
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.9rem; width: 100%;">Date finished:</label>
                                <input type="date" name="date_finished" value="{% if user_shelf.date_finished %}{{ user_shelf.date_finished|date:'Y-m-d' }}{% endif %}" style="padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; flex: 1; min-width: 150px;">
                                <button type="submit" class="btn btn-small">Save Date</button>
                            </div>
                        </form>
                    {% endif %}
                    <form method="post" action="{% url 'remove_from_shelf' book.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-secondary btn-small">Remove from Shelf</button>
                    </form>
                {% else %}
                    <form method="post" action="{% url 'add_to_shelf' book.pk %}">
                        {% csrf_token %}
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                            <select name="shelf_type" style="padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; flex: 1; min-width: 150px;">
                                <option value="want_to_read">Want to Read</option>
                                <option value="currently_reading">Currently Reading</option>
                                <option value="read">Read</option>
                            </select>
                            <button type="submit" class="btn btn-small">Add to Shelf</button>
                        </div>
                    </form>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h2 style="margin-bottom: 1rem;">Reviews</h2>
    
    {% if user.is_authenticated %}
        {% if user_review %}
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; border-left: 4px solid #3498db;">
                <p style="font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">Your Review</p>
                <p style="margin-bottom: 0.5rem; font-size: 0.9rem;">{{ user_review.content }}</p>
                <small style="color: #7f8c8d; font-size: 0.85rem;">{{ user_review.created_at|date:"M d, Y" }}</small>
                <div style="margin-top: 0.5rem;">
                    <a href="{% url 'add_review' book.pk %}" class="btn btn-small" style="margin-right: 0.5rem; margin-bottom: 0.5rem; display: inline-block;">Edit</a>
                    <form method="post" action="{% url 'delete_review' user_review.pk %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-small" style="margin-bottom: 0.5rem; display: inline-block;" onclick="return confirm('Delete this review?')">Delete</button>
                    </form>
                </div>
            </div>
        {% else %}
            <a href="{% url 'add_review' book.pk %}" class="btn btn-small" style="margin-bottom: 1.5rem; display: inline-block;">Write a Review</a>
        {% endif %}
    {% endif %}
    
    {% for review in reviews %}
        {% if review.user != user %}
            <div style="padding: 1rem 0; border-bottom: 1px solid #ecf0f1;">
                <p style="font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem;">{{ review.user.username }}</p>
                <p style="margin-bottom: 0.5rem; font-size: 0.9rem;">{{ review.content }}</p>
                <small style="color: #7f8c8d; font-size: 0.85rem;">{{ review.created_at|date:"M d, Y" }}</small>
            </div>
        {% endif %}
    {% empty %}
        {% if not user_review %}
            <p style="color: #7f8c8d; font-size: 0.9rem;">No reviews yet. Be the first to review this book!</p>
        {% endif %}
    {% endfor %}
</div>

@media (min-width: 768px) {
    .book-detail-container > div:first-child {
        max-width: 250px;
    }
    
    h1 {
        font-size: 2rem;
    }
    
    h2 {
        font-size: 1.5rem;
    }
}
{% endblock %}
